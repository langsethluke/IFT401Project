{% extends "index.html" %}
{% block title %}{{ stock_information.stock_name }}{% endblock %}
{% block content %}
<body>
    <div class="container-fluid ps-4">
        <div class="row">
            <div class="col">
                <br>
                <h1>{{ stock_information.stock_name }}</h1>
                <h5>{{ stock_information.ticker_symbol }}</h5>
                <br>
            </div>
        </div>
        <div class="row">
            <div class="col-7">
                <h2>Current Price: ${{ "{:,.2f}".format(stock_information.current_market_price) }}</h2>
                <h3>Today's Change: Display Total Value Change%</h3>
                <br>
                <h6>Opening Price: ${{ "{:,.2f}".format(stock_information.opening_price) }}</h6>
                <h6>Today's High: ${{ "{:,.2f}".format(stock_information.todays_high) }}</h6>
                <h6>Today's Low: ${{ "{:,.2f}".format(stock_information.todays_low) }}</h6>
                <h6>Total Market Cap: ${{ "{:,.2f}".format(stock_information.total_market_cap) }}</h6>
                <br>
                <canvas id="myChart"></canvas>
            </div>
            <div class="col-5 text-center">
                <h3>Current Purchasing Power: ${{ "{:,.2f}".format(portfolio.cash_balance) }}</h3>
                <br>
                <h4 id="shares">Number of Shares Available to Purchase: {{ stock_information.number_of_shares_to_purchase }}</h4>
                <br>
                <br>
                <button id="buy" type="button" class="button-green btn btn-secondary me-3" style="width:85px">Buy</button>
                <button id="sell" type="button" class="button-red btn btn-secondary" style="width:85px">Sell</button>
                <br>
                <br>
                <br>
                <form id="buyForm" method="POST" action="" onsubmit="return confirmBuy();">
                    {{ stockForm.hidden_tag() }}
                    <div class="mb-3">
                      <p id="stockInput">{{ stockForm.numOfShares(class="input form-control w-50 mx-auto text-center", placeholder="Number of Shares")}}</p>
                    </div>
                <br>
                <h5 id="displayTotal">Total Amount: $0</h5>
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                        <h5 class="error">{{ message }}</h5>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                <br>
                    <p id="stockButton">{{ stockForm.submit(class="button-green btn btn-primary w-25", value="Buy") }}</p>
                </form>
            </div>
        </div> 
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>

<script>

    const ctx = document.getElementById("myChart");

    const chartData = {
        labels: ["9:30am", "10am", "10:30am", "11am", "11:30am", "12pm", "12:30pm", "1pm", "1:30pm", "2pm", "2:30pm", "3pm", "3:30pm", "4pm"],
        data: ["{{ stock_information.current_market_price}}",],
    };

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    data: chartData.data,
                    borderColor: 'green',
                    backgroundColor: 'rgba(0, 128, 0, 0.13)',
                    fill: true,
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            interaction: {
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: false,
                }
            }
        }
    })

    document.getElementById('buy').addEventListener('click', function() {
        document.getElementById('shares').innerHTML = "Number of Shares Available: {{ stock_information.number_of_shares_to_purchase }}";
        document.getElementById('buyForm').setAttribute("onsubmit", "return confirmBuy();");
        document.getElementById('stockButton').innerHTML = '{{ stockForm.submit(class="button-green btn btn-primary w-25", value="Buy") }}';

    });

    document.getElementById('sell').addEventListener('click', function() {
        document.getElementById('shares').innerHTML = "Number of Shares Owned: {{ numOfSharesOwned }}";
        document.getElementById('buyForm').setAttribute("onsubmit", "return confirmSell();");
        document.getElementById('stockButton').innerHTML = '{{ stockForm.submit(class="button-red btn btn-primary w-25", value="Sell") }}';
    });

    var stockname = "{{ stock_information.stock_name }}";
    var cost = "{{ stock_information.current_market_price }}";
    var numOfSharesMain = document.getElementById("numOfShares");

    document.getElementById("numOfShares").addEventListener("keyup", function changeText()
    {
        var numOfShares = this.value
        var total = numOfShares * cost;

        document.getElementById("displayTotal").innerHTML = "Total Amount: $" + total.toFixed(2);
    })

    function confirmBuy() {
        var numOfShares = numOfSharesMain.value;
        var total = numOfShares * cost;
        var stock_name = stockname

        return confirm("Confirm the Purchase Order of " + numOfShares + " Share\(s\)" +  " of " + stock_name + " for a Total Amount of $" + total.toFixed(2));
    }

    function confirmSell() {
        var numOfShares = numOfSharesMain.value;
        var total = numOfShares * cost;
        var stock_name = stockname

        return confirm("Confirm the Sale Order of " + numOfShares + " Share\(s\)" +  " of " + stock_name + " for a Total Amount of $" + total.toFixed(2));
    }
</script>
{% endblock %}